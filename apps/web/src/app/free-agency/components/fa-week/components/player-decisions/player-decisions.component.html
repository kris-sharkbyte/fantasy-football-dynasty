<div class="player-decisions-container">
  <!-- Market Trends Overview -->
  @if (marketTrends()) {
  <div class="market-trends-card">
    <h4>Market Overview</h4>
    <div class="trends-grid">
      <div class="trend-item">
        <span class="trend-label">Total Decisions:</span>
        <span class="trend-value">{{ marketTrends()?.totalDecisions }}</span>
      </div>
      <div class="trend-item">
        <span class="trend-label">Accepted:</span>
        <span class="trend-value success">{{
          marketTrends()?.acceptedCount
        }}</span>
      </div>
      <div class="trend-item">
        <span class="trend-label">Shortlisted:</span>
        <span class="trend-value warning">{{
          marketTrends()?.shortlistedCount
        }}</span>
      </div>
      <div class="trend-item">
        <span class="trend-label">Rejected:</span>
        <span class="trend-value danger">{{
          marketTrends()?.rejectedCount
        }}</span>
      </div>
      <div class="trend-item">
        <span class="trend-label">Avg Contract Score:</span>
        <span class="trend-value"
          >{{
            ((marketTrends()?.averageContractScore || 0) * 100).toFixed(0)
          }}%</span
        >
      </div>
      <div class="trend-item">
        <span class="trend-label">Market Pressure:</span>
        <span
          class="trend-value"
          [class]="getMarketPressureColor(marketTrends()?.marketPressure || 0)"
        >
          {{ getMarketPressureLabel(marketTrends()?.marketPressure || 0) }}
        </span>
      </div>
    </div>
  </div>
  }

  <!-- Decision Summary Cards -->
  <div class="decision-summary-grid">
    <!-- Accepted Contracts -->
    <p-card header="Accepted Contracts" class="summary-card accepted">
      <div class="summary-content">
        <div class="summary-count">
          <span class="count">{{ acceptedContracts().length }}</span>
          <span class="label">Contracts</span>
        </div>
        <div class="summary-value">
          @if (acceptedContracts().length > 0) {
          <span class="total-value">
            {{ formatCurrency(acceptedContractsTotal()) }}
          </span>
          <span class="label">Total Value</span>
          }
        </div>
      </div>
    </p-card>

    <!-- Shortlisted Bids -->
    <p-card header="Shortlisted Bids" class="summary-card shortlisted">
      <div class="summary-content">
        <div class="summary-count">
          <span class="count">{{ shortlistedBids().length }}</span>
          <span class="label">Bids</span>
        </div>
        <div class="summary-value">
          @if (shortlistedBids().length > 0) {
          <span class="total-value">
            {{ formatCurrency(shortlistedBidsTotal()) }}
          </span>
          <span class="label">Total Value</span>
          }
        </div>
      </div>
    </p-card>

    <!-- Rejected Bids -->
    <p-card header="Rejected Bids" class="summary-card rejected">
      <div class="summary-content">
        <div class="summary-count">
          <span class="count">{{ rejectedBids().length }}</span>
          <span class="label">Bids</span>
        </div>
        <div class="summary-value">
          @if (rejectedBids().length > 0) {
          <span class="total-value">
            {{ formatCurrency(rejectedBidsTotal()) }}
          </span>
          <span class="label">Total Value</span>
          }
        </div>
      </div>
    </p-card>
  </div>

  <!-- Player Decisions Table -->
  @if (playerDecisions().length > 0) {
  <p-card header="Player Decisions" class="decisions-card">
    <p-table
      [value]="playerDecisions()"
      [paginator]="true"
      [rows]="10"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} decisions"
      [rowsPerPageOptions]="[5, 10, 25]"
      styleClass="p-datatable-sm"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>Player</th>
          <th>Decision</th>
          <th>Market Context</th>
          <th>Starting Prospects</th>
          <th>Contract Analysis</th>
          <th>Trust Impact</th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-decision>
        <tr>
          <td>
            <div class="player-info">
              <strong>{{ decision.playerId }}</strong>
              <small class="player-id">ID: {{ decision.playerId }}</small>
            </div>
          </td>
          <td>
            @if (decision.decisions[0]) {
            <div class="decision-status">
              <p-tag
                [value]="getDecisionStatusLabel(decision.decisions[0])"
                [severity]="getDecisionStatusSeverity(decision.decisions[0])"
              >
              </p-tag>
              <small class="decision-timeline">
                {{ getDecisionTimelineStatus(decision.decisions[0]) }}
              </small>
            </div>
            }
          </td>
          <td>
            @if (decision.decisions[0]?.marketFactors) {
            <div class="market-context">
              <div class="market-item">
                <span class="label">Competing Offers:</span>
                <span class="value">{{
                  getCompetingOffersCount(decision.decisions[0])
                }}</span>
              </div>
              <div class="market-item">
                <span class="label">Position Demand:</span>
                <p-tag
                  [value]="getPositionalDemandLevel(decision.decisions[0])"
                  [severity]="getPositionalDemandColor(decision.decisions[0])"
                  size="small"
                >
                </p-tag>
              </div>
              <div class="market-item">
                <span class="label">Market Pressure:</span>
                <span
                  class="value"
                  [class]="
                    getMarketPressureColor(
                      decision.decisions[0].marketFactors.marketPressure
                    )
                  "
                >
                  {{
                    getMarketPressureLabel(
                      decision.decisions[0].marketFactors.marketPressure
                    )
                  }}
                </span>
              </div>
            </div>
            }
          </td>
          <td>
            @if (decision.decisions[0]?.startingPositionProspects) {
            <div class="starting-prospects">
              <p-tag
                [value]="
                  decision.decisions[0].startingPositionProspects.isStarter
                    ? 'Starter'
                    : 'Depth'
                "
                [severity]="
                  getStartingPositionColor(
                    decision.decisions[0].startingPositionProspects.confidence
                  )
                "
              >
              </p-tag>
              <small class="confidence">
                {{
                  (
                    decision.decisions[0].startingPositionProspects.confidence *
                    100
                  ).toFixed(0)
                }}% confidence
              </small>
              <small class="team-depth">
                {{ decision.decisions[0].startingPositionProspects.teamDepth }}
                depth
              </small>
            </div>
            }
          </td>
          <td>
            @if (decision.decisions[0]?.contractAnalysis) {
            <div class="contract-analysis">
              <div class="score-main">
                <span class="score"
                  >{{
                    (
                      decision.decisions[0].contractAnalysis.totalScore * 100
                    ).toFixed(0)
                  }}%</span
                >
                <small class="threshold">
                  vs
                  {{
                    (
                      decision.decisions[0].contractAnalysis.threshold * 100
                    ).toFixed(0)
                  }}% threshold
                </small>
              </div>
              <div class="score-breakdown">
                <small
                  >AAV:
                  {{
                    (
                      decision.decisions[0].contractAnalysis.aavScore * 100
                    ).toFixed(0)
                  }}%</small
                >
                <small
                  >Bonus:
                  {{
                    (
                      decision.decisions[0].contractAnalysis.signingBonusScore *
                      100
                    ).toFixed(0)
                  }}%</small
                >
              </div>
            </div>
            }
          </td>
          <td>
            @if (decision.decisions[0]?.trustImpact) {
            <div class="trust-impact">
              @for (teamId of getTrustImpactTeamIds(decision.decisions[0]);
              track teamId) {
              <div class="trust-item">
                <span class="team-id">{{ teamId }}</span>
                <span
                  class="impact-value"
                  [class]="
                    getTrustImpactColor(
                      decision.decisions[0].trustImpact![teamId]
                    )
                  "
                >
                  {{
                    formatTrustImpact(
                      decision.decisions[0].trustImpact![teamId]
                    )
                  }}
                </span>
              </div>
              }
            </div>
            }
          </td>
          <td>
            <p-button
              label="View Details"
              icon="pi pi-eye"
              size="small"
              (onClick)="openDecisionModal(decision)"
            >
            </p-button>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
  } @else {
  <p-card header="Player Decisions" styleClass="decisions-card">
    <div class="no-decisions">
      <p>
        No player decisions available yet. Players will evaluate offers when the
        week advances.
      </p>
    </div>
  </p-card>
  }

  <!-- Decision Detail Modal -->
  <p-dialog
    [visible]="showDecisionModal()"
    [modal]="true"
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '60rem' }"
    header="Player Decision Details"
    (onHide)="closeDecisionModal()"
  >
    @if (selectedDecision()) {
    <div class="decision-detail-content">
      @if (selectedDecisionData()) { @if (selectedDecisionStartingProspects()) {
      <!-- Starting Position Analysis -->
      <div class="detail-section">
        <h4>Starting Position Prospects</h4>
        <div class="prospects-grid">
          <div class="prospect-item">
            <span class="label">Starter Potential:</span>
            <p-tag
              [value]="
                selectedDecisionStartingProspects()?.isStarter ? 'Yes' : 'No'
              "
              [severity]="
                getStartingPositionColor(
                  selectedDecisionStartingProspects()?.confidence || 0
                )
              "
            >
            </p-tag>
          </div>
          <div class="prospect-item">
            <span class="label">Confidence:</span>
            <span class="value"
              >{{
                (
                  (selectedDecisionStartingProspects()?.confidence || 0) * 100
                ).toFixed(0)
              }}%</span
            >
          </div>
          <div class="prospect-item">
            <span class="label">Competing Players:</span>
            <span class="value">{{
              selectedDecisionStartingProspects()?.competingPlayers || 0
            }}</span>
          </div>
          <div class="prospect-item">
            <span class="label">Team Depth:</span>
            <p-tag
              [value]="
                selectedDecisionStartingProspects()?.teamDepth || 'unknown'
              "
              [severity]="
                getTeamDepthColor(
                  selectedDecisionStartingProspects()?.teamDepth || 'unknown'
                )
              "
            >
            </p-tag>
          </div>
        </div>
        <p class="reasoning">
          {{
            selectedDecisionStartingProspects()?.reasoning ||
              'No reasoning provided'
          }}
        </p>
      </div>
      } @if (selectedDecisionContractAnalysis()) {
      <!-- Contract Analysis -->
      <div class="detail-section">
        <h4>Contract Analysis</h4>
        <div class="contract-scores">
          <div class="score-item">
            <span class="label">AAV Score:</span>
            <span class="value"
              >{{
                (
                  (selectedDecisionContractAnalysis()?.aavScore || 0) * 100
                ).toFixed(0)
              }}%</span
            >
          </div>
          <div class="score-item">
            <span class="label">Signing Bonus Score:</span>
            <span class="value"
              >{{
                (
                  (selectedDecisionContractAnalysis()?.signingBonusScore || 0) *
                  100
                ).toFixed(0)
              }}%</span
            >
          </div>
          <div class="score-item">
            <span class="label">Guarantee Score:</span>
            <span class="value"
              >{{
                (
                  (selectedDecisionContractAnalysis()?.guaranteeScore || 0) *
                  100
                ).toFixed(0)
              }}%</span
            >
          </div>
          <div class="score-item">
            <span class="label">Length Score:</span>
            <span class="value"
              >{{
                (
                  (selectedDecisionContractAnalysis()?.lengthScore || 0) * 100
                ).toFixed(0)
              }}%</span
            >
          </div>
          <div class="score-item">
            <span class="label">Team Score:</span>
            <span class="value"
              >{{
                (
                  (selectedDecisionContractAnalysis()?.teamScore || 0) * 100
                ).toFixed(0)
              }}%</span
            >
          </div>
          <div class="score-item total">
            <span class="label">Total Score:</span>
            <span class="value"
              >{{
                (
                  (selectedDecisionContractAnalysis()?.totalScore || 0) * 100
                ).toFixed(0)
              }}%</span
            >
          </div>
        </div>
      </div>
      }

      <!-- Market Context -->
      @if (selectedDecisionData()?.marketFactors) {
      <div class="detail-section">
        <h4>Market Context</h4>
        <div class="market-details">
          <div class="market-grid">
            <div class="market-item">
              <span class="label">Competing Offers:</span>
              <span class="value">{{
                getCompetingOffersCount(selectedDecisionData()!)
              }}</span>
            </div>
            <div class="market-item">
              <span class="label">Position Demand:</span>
              <p-tag
                [value]="getPositionalDemandLevel(selectedDecisionData()!)"
                [severity]="getPositionalDemandColor(selectedDecisionData()!)"
              >
              </p-tag>
            </div>
            <div class="market-item">
              <span class="label">Market Pressure:</span>
              <span
                class="value"
                [class]="
                  getMarketPressureColor(
                    selectedDecisionData()!.marketFactors.marketPressure
                  )
                "
              >
                {{
                  getMarketPressureLabel(
                    selectedDecisionData()!.marketFactors.marketPressure
                  )
                }}
              </span>
            </div>
            @if (selectedDecisionData()!.marketFactors.recentComparables.length
            > 0) {
            <div class="market-item full-width">
              <span class="label">Recent Comparables:</span>
              <div class="comparables">
                @for (playerId of
                selectedDecisionData()!.marketFactors.recentComparables; track
                playerId) {
                <span class="comparable-player">{{ playerId }}</span>
                }
              </div>
            </div>
            }
          </div>
        </div>
      </div>
      }

      <!-- Trust Impact Analysis -->
      @if (selectedDecisionData()?.trustImpact &&
      getTrustImpactTeamIds(selectedDecisionData()!).length > 0) {
      <div class="detail-section">
        <h4>Trust Impact Analysis</h4>
        <div class="trust-impact-details">
          <p class="trust-description">
            This decision affects the player's relationship with various teams
            based on offer quality and negotiation history.
          </p>
          <div class="trust-grid">
            @for (teamId of getTrustImpactTeamIds(selectedDecisionData()!);
            track teamId) {
            <div class="trust-item">
              <span class="team-id">{{ teamId }}</span>
              <span
                class="impact-value"
                [class]="
                  getTrustImpactColor(
                    selectedDecisionData()!.trustImpact![teamId]
                  )
                "
              >
                {{
                  formatTrustImpact(
                    selectedDecisionData()!.trustImpact![teamId]
                  )
                }}
              </span>
              <small class="impact-description">
                @if (selectedDecisionData()!.trustImpact![teamId] > 0.1) {
                Improved relationship } @else if
                (selectedDecisionData()!.trustImpact![teamId] < -0.1) { Damaged
                relationship } @else { Neutral impact }
              </small>
            </div>
            }
          </div>
        </div>
      </div>
      }

      <!-- Player and Agent Notes -->
      <div class="detail-section">
        <h4>Player & Agent Feedback</h4>
        <div class="feedback-content">
          <div class="feedback-item">
            <h5>Player Notes:</h5>
            <p>
              {{
                selectedDecisionData()?.playerNotes ||
                  'No player notes available'
              }}
            </p>
          </div>
          <div class="feedback-item">
            <h5>Agent Assessment:</h5>
            <p>
              {{
                selectedDecisionData()?.agentNotes ||
                  'No agent assessment available'
              }}
            </p>
          </div>
          <div class="feedback-item">
            <h5>Decision Reasoning:</h5>
            <p>
              {{
                selectedDecisionData()?.feedback ||
                  'No detailed reasoning provided'
              }}
            </p>
          </div>
        </div>
      </div>
      }
    </div>
    }
  </p-dialog>
</div>

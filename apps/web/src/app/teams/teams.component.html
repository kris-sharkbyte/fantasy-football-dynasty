<div class="teams-container">
  <!-- Loading State -->
  @if (isLoading()) {
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading teams...</p>
  </div>
  }

  <!-- Error State -->
  @if (error()) {
  <div class="error-container">
    <p class="error-message">{{ error() }}</p>
    <button class="btn-secondary" (click)="clearError()">Dismiss</button>
  </div>
  }

  <!-- No Teams State -->
  @if (!isLoading() && !hasTeams()) {
  <div class="no-teams-container">
    <h2>No Teams Found</h2>
    <p>
      You don't have any teams yet. Create a team in a league to get started.
    </p>
    <button class="btn-primary" routerLink="/leagues">Go to Leagues</button>
  </div>
  }

  <!-- Teams Content -->
  @if (hasTeams() && !isLoading()) {
  <div class="teams-content">
    <!-- Team Selection Sidebar -->
    <app-team-sidebar
      [teams]="teams()"
      [selectedTeam]="selectedTeam()"
      (teamSelected)="selectTeam($event)"
    ></app-team-sidebar>

    <!-- Team Details and Roster -->
    @if (selectedTeam()) {
    <div class="team-details">
      <!-- Team Header -->
      <app-team-header
        [team]="selectedTeam()"
        [isDraftActive]="isDraftActive()"
        (startDraft)="startDraft()"
        (openPlayerSearch)="openPlayerSearch()"
      ></app-team-header>

      <!-- Roster Statistics -->
      <app-roster-stats [stats]="getRosterStats()"></app-roster-stats>

      <!-- Roster Validation -->
      @if (validateRoster()) {
      <div class="roster-validation" [class.valid]="validateRoster().isValid">
        @if (validateRoster().isValid) {
        <div class="validation-success">✅ Roster meets all requirements</div>
        } @else {
        <div class="validation-issues">
          <h4>⚠️ Roster Issues:</h4>
          <ul>
            @for (issue of validateRoster().issues; track issue) {
            <li>{{ issue }}</li>
            }
          </ul>
        </div>
        }
      </div>
      }

      <!-- Roster by Position -->
      <div class="roster-sections">
        @for (position of ['QB', 'RB', 'WR', 'TE', 'K', 'DEF']; track position)
        {
        <div class="roster-section">
          <h3>
            {{ getPositionDisplayName(position) }} ({{
              getRosterByPosition(position).length
            }})
          </h3>
          <div class="roster-players">
            @for (slot of getRosterByPosition(position); track slot.id) { @if
            (getPlayerDetails(slot.playerId)) {
            <div class="player-card" [class]="'status-' + slot.status">
              <div class="player-info">
                <div class="player-name">
                  {{ formatPlayerName(getPlayerDetails(slot.playerId)!) }}
                </div>
                <div class="player-details">
                  <span class="team">{{
                    getPlayerDetails(slot.playerId)?.team
                  }}</span>
                  <span class="age"
                    >{{ getPlayerDetails(slot.playerId)?.age }} yrs</span
                  >
                  <span class="exp"
                    >{{ getPlayerDetails(slot.playerId)?.years_exp }} exp</span
                  >
                </div>
              </div>
              <div class="player-actions">
                <select
                  [value]="slot.status"
                  (change)="onStatusChange(slot.playerId, $event)"
                  class="status-select"
                >
                  <option value="active">Active</option>
                  <option value="bench">Bench</option>
                  <option value="ir">IR</option>
                  <option value="taxi">Taxi</option>
                </select>
                <button
                  class="btn-remove"
                  (click)="removePlayerFromRoster(slot.playerId)"
                  title="Remove player"
                >
                  ×
                </button>
              </div>
            </div>
            } } @if (getRosterByPosition(position).length === 0) {
            <div class="no-players">
              <p>No {{ getPositionDisplayName(position) }}s on roster</p>
            </div>
            }
          </div>
        </div>
        }
      </div>
    </div>
    }

    <!-- No Team Selected -->
    @if (!selectedTeam()) {
    <div class="no-team-selected">
      <h3>Select a Team</h3>
      <p>
        Choose a team from the sidebar to view its roster and manage players.
      </p>
    </div>
    }
  </div>
  }
</div>

<!-- Draft Simulation Modal -->
@if (showDraftModal()) {
<div class="modal-overlay" (click)="hideDraftModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Draft Simulation</h3>
      <button class="modal-close" (click)="hideDraftModal()">×</button>
    </div>

    <div class="modal-body">
      @if (isDraftActive()) {
      <div class="draft-status">
        <div class="draft-info">
          <p><strong>Round:</strong> {{ draftState()?.currentRound }}</p>
          <p><strong>Pick:</strong> {{ draftState()?.currentPick }}</p>
          <p><strong>Status:</strong> Active</p>
        </div>

        <div class="draft-actions">
          <button class="btn-primary" (click)="autoPick()">Auto-Pick</button>
          <button class="btn-secondary" (click)="endDraft()">End Draft</button>
        </div>
      </div>

      <!-- Available Players for Draft -->
      <div class="available-players">
        <h4>Available Players</h4>
        <div class="player-grid">
          @for (player of getTopAvailablePlayers(); track player.player_id) {
          <div class="draft-player-card">
            <div class="player-name">{{ formatPlayerName(player) }}</div>
            <div class="player-position">{{ player.position }}</div>
            <div class="player-team">{{ player.team }}</div>
            <button class="btn-draft" (click)="makePick(player.player_id)">
              Draft
            </button>
          </div>
          }
        </div>
      </div>
      } @else {
      <div class="draft-complete">
        <h4>Draft Complete!</h4>
        <p>The draft simulation has finished.</p>
        <div class="draft-stats">
          <p><strong>Total Picks:</strong> {{ getDraftStats()?.totalPicks }}</p>
          <p><strong>Duration:</strong> {{ getDraftDuration() }}</p>
        </div>
        <button class="btn-primary" (click)="resetDraft()">
          Start New Draft
        </button>
      </div>
      }
    </div>
  </div>
</div>
}

<!-- Player Search Modal -->
@if (showPlayerSearch()) {
<div class="modal-overlay" (click)="hidePlayerSearch()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Add Player to Roster</h3>
      <button class="modal-close" (click)="hidePlayerSearch()">×</button>
    </div>

    <div class="modal-body">
      <!-- Search Form -->
      <div class="search-form">
        <div class="search-inputs">
          <input
            type="text"
            placeholder="Search by name or team..."
            [ngModel]="searchQuery()"
            (ngModelChange)="searchQuery.set($event)"
            class="search-input"
          />
          <select
            [ngModel]="selectedPosition()"
            (ngModelChange)="selectedPosition.set($event)"
            class="position-select"
          >
            <option value="">All Positions</option>
            <option value="QB">QB</option>
            <option value="RB">RB</option>
            <option value="WR">WR</option>
            <option value="TE">TE</option>
            <option value="K">K</option>
            <option value="DEF">DEF</option>
          </select>
          <button
            class="btn-primary"
            (click)="searchPlayers()"
            [disabled]="isLoadingPlayers()"
          >
            {{ isLoadingPlayers() ? 'Searching...' : 'Search' }}
          </button>
        </div>
      </div>

      <!-- Search Results -->
      @if (searchResults.length > 0) {
      <div class="search-results">
        <h4>Results ({{ searchResults.length }})</h4>
        <div class="player-list">
          @for (player of searchResults; track player.player_id) {
          <div class="search-player-card">
            <div class="player-info">
              <div class="player-name">{{ formatPlayerName(player) }}</div>
              <div class="player-details">
                <span class="position">{{ player.position }}</span>
                <span class="team">{{ player.team }}</span>
                <span class="age">{{ player.age }} yrs</span>
                <span class="exp">{{ player.years_exp }} exp</span>
              </div>
            </div>
            <button class="btn-add" (click)="addPlayerToRoster(player)">
              Add to Roster
            </button>
          </div>
          }
        </div>
      </div>
      } @else if (searchQuery() || selectedPosition()) {
      <div class="no-results">
        <p>No players found matching your search criteria.</p>
      </div>
      } @else {
      <div class="search-prompt">
        <p>
          Enter a player name or select a position to search for available
          players.
        </p>
      </div>
      }
    </div>
  </div>
</div>
}
